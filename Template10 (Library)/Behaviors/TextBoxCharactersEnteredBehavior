using System;
using Windows.UI.Xaml;
using Windows.UI.Xaml.Controls;
using Windows.UI.Xaml.Markup;
using Microsoft.Xaml.Interactivity;

namespace Template10.Behaviors
{
    [ContentProperty(Name = nameof(Actions))]
    [TypeConstraint(typeof(TextBox))]
    public class TextBoxCharactersEnteredBehavior : DependencyObject, IBehavior
    {
        private TextBox AssociatedTextBox => AssociatedObject as TextBox;
        public DependencyObject AssociatedObject { get; private set; }

        public void Attach(DependencyObject associatedObject)
        {
            AssociatedObject = associatedObject;
            AssociatedTextBox.TextChanged += AssociatedTextBox_TextChanged;
        }

        public string CharacterCount
        {
            get { return ((uint)GetValue(CharacterCountProperty)).ToString(); }
            set { SetValue(CharacterCountProperty, Convert.ToUInt32(value)); }
        }

        public static readonly DependencyProperty CharacterCountProperty = DependencyProperty.Register(nameof(CharacterCount),
            typeof(uint), typeof(TextBoxCharactersEnteredBehavior), new PropertyMetadata(null));
        public void Detach()
        {
            AssociatedTextBox.TextChanged -= AssociatedTextBox_TextChanged;
        }

        private void AssociatedTextBox_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (AssociatedTextBox.Text.Length == Convert.ToUInt32(CharacterCount))
                Interaction.ExecuteActions(AssociatedObject, Actions, null);
        }

        public ActionCollection Actions
        {
            get
            {
                var actions = (ActionCollection)base.GetValue(ActionsProperty);
                if (actions == null)
                {
                    base.SetValue(ActionsProperty, actions = new ActionCollection());
                }
                return actions;
            }
        }
        public static readonly DependencyProperty ActionsProperty =
            DependencyProperty.Register(nameof(Actions), typeof(ActionCollection),
                typeof(TextBoxEnterKeyBehavior), new PropertyMetadata(null));
    }
}
